<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒªãƒ¼ã‚¹å“ å€Ÿå…¥ãƒ»è¿”å´ ç®¡ç†</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#1f2937; --muted:#6b7280;
      --line:#e5e7eb; --card:#f9fafb; --accent:#2563eb;
      --danger:#dc2626; --ok:#16a34a;
      --radius:14px;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; color:var(--fg); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 16px; }
    h1{ margin:0; font-size:18px; }
    .muted{ color:var(--muted); font-size:13px; }
    .tabs{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .tab{ border:1px solid var(--line); background:var(--card); padding:10px 12px; border-radius:12px; cursor:pointer; }
    .tab.active{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.12); }
    main{ padding:16px; }
    .card{ background:var(--bg); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, select, textarea{ width:100%; padding:10px 11px; border:1px solid var(--line); border-radius:12px; font-size:14px; background:#fff; }
    textarea{ min-height:80px; resize:vertical; }
    .btn{ border:0; background:var(--accent); color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:#111827; }
    .btn.ghost{ background:transparent; color:var(--fg); border:1px solid var(--line); }
    .btn.danger{ background:var(--danger); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); }
    .pill{ display:inline-block; padding:4px 10px; border:1px solid var(--line); border-radius:999px; background:var(--card); font-size:12px; }
    .right{ text-align:right; }
    .grid3{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 920px){ .grid3{ grid-template-columns: 1fr; } }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ãƒªãƒ¼ã‚¹å“ å€Ÿå…¥ãƒ»è¿”å´ ç®¡ç†</h1>
    <div class="muted">æ–°è¦ç™»éŒ² / ä¸€è¦§ / è¿”å´ç™»éŒ²ï¼ˆè¿”å´æ“ä½œã¯è¿”å´ç™»éŒ²ã«é›†ç´„ï¼‰</div>
    <div class="tabs">
      <button class="tab active" id="tabNew" type="button">æ–°è¦ç™»éŒ²</button>
      <button class="tab" id="tabList" type="button">ä¸€è¦§ã‚’è¦‹ã‚‹</button>
      <button class="tab" id="tabReturn" type="button">è¿”å´ç™»éŒ²</button>
      <span class="muted" id="statusMsg"></span>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- æ–°è¦ç™»éŒ² -->
  <section id="viewNew">
    <div class="card">
      <h2 style="margin:0 0 6px;">æ–°è¦ç™»éŒ²</h2>
      <div class="muted">å¿…é ˆï¼šç¾å ´ / å“å / æ•°é‡ / å€Ÿå…¥æ—¥</div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <label>ç¾å ´</label>
          <input id="project" placeholder="ä¾‹ï¼šç†Šé‡æ±Ÿ" />
        </div>
        <div>
          <label>å“å</label>
          <input id="itemName" placeholder="ä¾‹ï¼šå˜ç®¡ãƒ‘ã‚¤ãƒ—" />
        </div>
        <div>
          <label>æ•°é‡ï¼ˆå€Ÿå…¥ï¼‰</label>
          <input id="qty" type="number" min="1" step="1" placeholder="ä¾‹ï¼š20" />
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <label>å€Ÿå…¥æ—¥</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label>è¿”å´äºˆå®šæ—¥ï¼ˆä»»æ„ï¼‰</label>
          <input id="dueDate" type="date" />
        </div>
        <div>
          <label>ä¼šç¤¾ï¼ˆä»»æ„ï¼‰</label>
          <input id="vendor" placeholder="ä¾‹ï¼šã€‡ã€‡ãƒªãƒ¼ã‚¹" />
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <label>ä¼ç¥¨Noï¼ˆä»»æ„ï¼‰</label>
          <input id="slipNo" placeholder="ä¾‹ï¼šR-12345" />
        </div>
        <div>
          <label>è³‡ç”£ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
          <input id="assetNo" placeholder="ä¾‹ï¼šA-001" />
        </div>
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="memo" placeholder="ä¾‹ï¼šè¿”å´æ™‚æ¸…æƒ" />
        </div>
      </div>

      <!-- OCR -->
      <div class="card" style="margin-top:14px; box-shadow:none; background:var(--card);">
        <h3 style="margin:0 0 6px; font-size:15px;">ä¼ç¥¨ã‚’æ’®å½± â†’ OCRã§è‡ªå‹•å…¥åŠ›ï¼ˆæ·»ä»˜ä¿å­˜ï¼‰</h3>
        <div class="muted">æ’®å½±/é¸æŠ â†’ Driveã«ä¿å­˜ï¼ˆæ·»ä»˜ï¼‰ â†’ OCR â†’ ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆæœ€çµ‚ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>ä¼ç¥¨ç”»åƒ</label>
            <input id="slipFile" type="file" accept="image/*" capture="environment" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button id="btnCamera" class="btn ghost" type="button">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
              <button id="btnOcr" class="btn" type="button" disabled>OCRå®Ÿè¡Œï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
            </div>
          </div>
        </div>
        <div style="margin-top:10px;">
          <img id="slipPreview" alt="ä¼ç¥¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="hidden" style="max-width:100%; max-height:240px; border:1px solid var(--line); border-radius:12px;" />
          <div id="slipInfo" class="muted" style="margin-top:8px;"></div>
          <div id="ocrTextBox" class="muted hidden" style="white-space:pre-wrap; margin-top:10px; padding:10px; background:#fff; border:1px solid var(--line); border-radius:12px;"></div>
        </div>
      </div>

      <div class="actions">
        <button id="btnAdd" class="btn" type="button">ç™»éŒ²</button>
        <button id="btnClear" class="btn ghost" type="button">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
  </section>

  <!-- ä¸€è¦§ -->
  <section id="viewList" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap;">
        <div>
          <h2 style="margin:0 0 6px;">ä¸€è¦§</h2>
          <div class="muted">è¿”å´ã¯ã€Œè¿”å´ç™»éŒ²ã€ç”»é¢ã§è¡Œã„ã¾ã™ï¼ˆä¸€è¦§ã¯é–²è¦§ï¼‹è¿”å´ç”»é¢ã¸èª˜å°ï¼‰</div>
        </div>
        <div style="min-width:240px;">
          <label>æ¤œç´¢</label>
          <input id="listSearch" placeholder="ç¾å ´/å“å/ä¼ç¥¨No ã§æ¤œç´¢" />
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table id="listTable">
          <thead>
            <tr>
              <th>ç¾å ´</th>
              <th>å“å</th>
              <th class="right">æ•°é‡</th>
              <th class="right">æ®‹</th>
              <th>ä¼ç¥¨</th>
              <th>å€Ÿå…¥æ—¥</th>
              <th>äºˆå®š</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
      <div class="actions">
        <button id="btnRefresh" class="btn ghost" type="button">å†èª­è¾¼</button>
      </div>
    </div>
  </section>

  <!-- è¿”å´ç™»éŒ² -->
  <section id="viewReturn" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 6px;">è¿”å´ç™»éŒ²</h2>
      <div class="muted">å¯¾è±¡ã‚’é¸æŠã—ã¦è¿”å´ã‚’ç™»éŒ²ã—ã¾ã™ï¼ˆä¸€è¦§ã®è¿”å´æ“ä½œã‚’ã“ã¡ã‚‰ã¸ç§»å‹•ï¼‰</div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>å¯¾è±¡ï¼ˆæ¤œç´¢ï¼‰</label>
          <input id="retSearch" placeholder="ç¾å ´/å“å/ä¼ç¥¨No ã§æ¤œç´¢" />
          <select id="retSelect" style="margin-top:8px;"></select>
          <div id="retSlipLink" class="muted" style="margin-top:8px;"></div>

        <!-- è¿”å´ä¼ç¥¨ OCR -->
        <div class="card" style="margin-top:12px; box-shadow:none; background:var(--card);">
          <h3 style="margin:0 0 6px; font-size:15px;">è¿”å´ä¼ç¥¨ã‚’æ’®å½± â†’ OCRï¼ˆæ·»ä»˜ä¿å­˜ï¼‰</h3>
          <div class="muted">è¿”å´æ™‚ã®ä¼ç¥¨ç”»åƒã‚‚Driveã«ä¿å­˜ã—ã€å¿…è¦ã«å¿œã˜ã¦OCRã§ãƒ¡ãƒ¢ç­‰ã«æ´»ç”¨ã§ãã¾ã™ï¼ˆæœ€çµ‚ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚</div>
          <div class="row" style="margin-top:10px;">
            <div>
              <label>è¿”å´ä¼ç¥¨ç”»åƒ</label>
              <input id="retSlipFile" type="file" accept="image/*" capture="environment" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="actions">
                <button id="btnRetCamera" class="btn ghost" type="button">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
                <button id="btnRetOcr" class="btn" type="button" disabled>OCRå®Ÿè¡Œï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
              </div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <img id="retSlipPreview" alt="è¿”å´ä¼ç¥¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="hidden" style="max-width:100%; max-height:240px; border:1px solid var(--line); border-radius:12px;" />
            <div id="retSlipInfo" class="muted" style="margin-top:8px;"></div>
            <div id="retOcrTextBox" class="muted hidden" style="white-space:pre-wrap; margin-top:10px; padding:10px; background:#fff; border:1px solid var(--line); border-radius:12px;"></div>
          </div>
        </div>

        </div>
        <div>
          <label>å€Ÿå…¥ä¸­æ•°é‡ï¼ˆæ®‹ï¼‰</label>
          <div id="retQtyOut" class="pill">-</div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>è¿”å´æ•°é‡</label>
              <input id="retQty" type="number" min="1" step="1" value="1" />
            </div>
            <div>
              <label>è¿”å´æ—¥</label>
              <input id="retDate" type="date" />
            </div>
          </div>

          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="retMemo" placeholder="ä¾‹ï¼šä¸€éƒ¨è¿”å´ / ç ´æã‚ã‚Š ç­‰" />

          <div class="actions">
            <button id="btnReturn" class="btn" type="button">è¿”å´ç™»éŒ²</button>
            <button id="btnUndo" class="btn ghost" type="button">ç›´å‰è¿”å´ã‚’å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin:0 0 6px; font-size:15px;">è¿”å´å±¥æ­´ï¼ˆé¸æŠä¸­ï¼‰</h3>
      <div id="retHistoryEmpty" class="muted">å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      <div style="overflow:auto;">
        <table id="retHistoryTable" class="hidden">
          <thead><tr><th style="width:140px;">è¿”å´æ—¥</th><th style="width:100px;" class="right">æ•°é‡</th><th>ãƒ¡ãƒ¢</th></tr></thead>
          <tbody id="retHistoryBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
  // ===== è¨­å®š =====
  const API_URL = "https://script.google.com/macros/s/AKfycbw_KxLcGaILCGgKLyVaoYPYm_9nNwuZlTCG7mP9gVjWWncURT-9rjvCuc_jTUedhMoA/exec";

  // ===== çŠ¶æ…‹ =====
  const state = { items: [] };
  let slipUploadUrl = "";
  let slipOcrText = "";
  let retSlipUploadUrl = "";
  let retSlipOcrText = "";

  // ===== util =====
  const $ = (id)=> document.getElementById(id);
  function setBusy_(msg){
    $("statusMsg").textContent = msg || "";
  }
  function escapeHtml_(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }
  function toYmdToday_(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  // JSONPï¼ˆGAS WebAppï¼‰
  function fetchJsonp_(url, params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const script = document.createElement("script");
      const qs = new URLSearchParams({ ...(params||{}), callback: cb });
      script.src = url + (url.includes("?") ? "&" : "?") + qs.toString();
      const timer = setTimeout(()=>{
        cleanup_();
        reject(new Error("timeout"));
      }, 25000);

      function cleanup_(){
        clearTimeout(timer);
        delete window[cb];
        script.remove();
      }
      window[cb] = (data)=>{ cleanup_(); resolve(data); };
      script.onerror = ()=>{ cleanup_(); reject(new Error("network/script error")); };
      document.body.appendChild(script);
    });
  }

  // ===== ç”»é¢åˆ‡æ›¿ =====
  function showView_(name){
    const views = [
      ["new","viewNew","tabNew"],
      ["list","viewList","tabList"],
      ["return","viewReturn","tabReturn"]
    ];
    for(const [k, vid, tid] of views){
      $(vid).classList.toggle("hidden", k !== name);
      $(tid).classList.toggle("active", k === name);
    }
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ===== OCR =====
  function fileToDataUrl_(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = ()=> reject(fr.error || new Error("file read error"));
      fr.readAsDataURL(file);
    });
  }
  function normalizeText_(t){
    return (t||"")
      .replace(/[ï¼š]/g, ":")
      .replace(/[ï¼-ï¼™]/g, (d)=> String.fromCharCode(d.charCodeAt(0) - 0xFEE0))
      .replace(/[ï¼¡-ï¼ºï½-ï½š]/g, (c)=> String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
      .replace(/\u00A0/g, " ")
      .replace(/[ \t]+/g, " ")
      .replace(/\r/g, "");
  }
  function pickDate_(t){
    const s = normalizeText_(t);
    const m1 = s.match(/(20\\d{2})[\\/\\-\\.](\\d{1,2})[\\/\\-\\.](\\d{1,2})/);
    if(m1){
      const y = m1[1];
      const mo = String(m1[2]).padStart(2,"0");
      const d = String(m1[3]).padStart(2,"0");
      return `${y}-${mo}-${d}`;
    }
    return "";
  }
  function pickSlipNo_(t){
    const s = normalizeText_(t);
    const m = s.match(/(?:ä¼ç¥¨|ä¼ç¥¨No|ä¼ç¥¨NO|No|NO|ç•ªå·)\\s*[:#]?\\s*([A-Za-z0-9\\-\\/]{3,})/i);
    return m ? m[1] : "";
  }
  function pickQty_(t){
    const s = normalizeText_(t);
    const m = s.match(/(?:æ•°é‡|æ•°)\\s*[: ]\\s*([0-9]{1,5})/);
    if(m) return Number(m[1]);
    const m2 = s.match(/([0-9]{1,5})\\s*(?:æœ¬|æš|å€‹|å°|å¼|è¢‹|ç®±)/);
    if(m2) return Number(m2[1]);
    return null;
  }
  function pickVendor_(t){
    const s = normalizeText_(t);
    const lines = s.split("\\n").map(x=>x.trim()).filter(Boolean);
    for(const line of lines.slice(0,10)){
      if(/(æ ªå¼ä¼šç¤¾|\\(æ ª\\)|ï¼ˆæ ªï¼‰|æœ‰é™ä¼šç¤¾|\\(æœ‰\\)|ãƒªãƒ¼ã‚¹|ãƒ¬ãƒ³ã‚¿ãƒ«|å•†åº—|å»ºè¨­|å·¥æ¥­|ã‚»ãƒ³ã‚¿ãƒ¼|æ”¯åº—)/.test(line) && line.length <= 30){
        return line;
      }
    }
    return "";
  }
  function pickItemName_(t){
    const s = normalizeText_(t);
    const m = s.match(/(?:å“å|å•†å“|å“ç›®)\\s*[: ]\\s*([^\\n]{2,40})/);
    return m ? m[1].trim() : "";
  }
  function applyOcrToForm_(ocrText){
    const t = normalizeText_(ocrText);
    const vendor = pickVendor_(t);
    if(vendor && !$("vendor").value) $("vendor").value = vendor;
    const slipNo = pickSlipNo_(t);
    if(slipNo && !$("slipNo").value) $("slipNo").value = slipNo;
    const name = pickItemName_(t);
    if(name && !$("itemName").value) $("itemName").value = name;
    const qty = pickQty_(t);
    if(qty && !$("qty").value) $("qty").value = String(qty);
    const d = pickDate_(t);
    if(d && !$("startDate").value) $("startDate").value = d;
  }

  async function runOcrUpload_(){
    const file = $("slipFile").files && $("slipFile").files[0];
    if(!file){ alert("ä¼ç¥¨ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("btnOcr").disabled = true;
    setBusy_("OCRã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");
    try{
      const dataUrl = await fileToDataUrl_(file);
      const base64 = (dataUrl.split(",")[1] || "");
      const res = await fetchJsonp_(`${API_URL}?action=uploadSlip`, {
        filename: file.name || `slip_${Date.now()}.jpg`,
        mime: file.type || "image/jpeg",
        data: base64
      });
      if(!res.ok) throw new Error(res.error || "uploadSlip failed");

      slipUploadUrl = res.file_url || "";
      slipOcrText = res.ocr_text || "";

      $("slipInfo").innerHTML = slipUploadUrl ? `ä¿å­˜å…ˆ: <a href="${escapeHtml_(slipUploadUrl)}" target="_blank" rel="noopener">Driveã§é–‹ã</a>` : "";
      $("ocrTextBox").classList.remove("hidden");
      $("ocrTextBox").textContent = slipOcrText
        ? `OCRçµæœï¼ˆæŠœç²‹ï¼‰:\\n${slipOcrText.slice(0,1200)}${slipOcrText.length>1200?"\\nâ€¦(çœç•¥)":""}`
        : "OCRçµæœ: ï¼ˆèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼‰";

      if(slipOcrText) applyOcrToForm_(slipOcrText);
      setBusy_("");
    }catch(err){
      console.error(err);
      alert(`OCRã§ã‚¨ãƒ©ãƒ¼: ${err.message || err}`);
      setBusy_("");
    }finally{
      $("btnOcr").disabled = false;
    }
  }

  async function runRetOcrUpload_(){
    const file = $("retSlipFile").files && $("retSlipFile").files[0];
    if(!file){ alert("è¿”å´ä¼ç¥¨ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("btnRetOcr").disabled = true;
    setBusy_("è¿”å´ä¼ç¥¨OCRã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");
    try{
      const dataUrl = await fileToDataUrl_(file);
      const base64 = (dataUrl.split(",")[1] || "");
      const res = await fetchJsonp_(`${API_URL}?action=uploadSlip`, {
        filename: file.name || `return_slip_${Date.now()}.jpg`,
        mime: file.type || "image/jpeg",
        data: base64
      });
      if(!res.ok) throw new Error(res.error || "uploadSlip failed");

      retSlipUploadUrl = res.file_url || "";
      retSlipOcrText = res.ocr_text || "";

      $("retSlipInfo").innerHTML = retSlipUploadUrl ? `ä¿å­˜å…ˆ: <a href="${escapeHtml_(retSlipUploadUrl)}" target="_blank" rel="noopener">Driveã§é–‹ã</a>` : "";
      $("retOcrTextBox").classList.remove("hidden");
      $("retOcrTextBox").textContent = retSlipOcrText
        ? `OCRçµæœï¼ˆæŠœç²‹ï¼‰:\n${retSlipOcrText.slice(0,1200)}${retSlipOcrText.length>1200?"\nâ€¦(çœç•¥)":""}`
        : "OCRçµæœ: ï¼ˆèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼‰";

      if(!$("retMemo").value && retSlipOcrText){
        const slip = pickSlipNo_(retSlipOcrText);
        if(slip) $("retMemo").value = `è¿”å´ä¼ç¥¨:${slip}`;
      }
      setBusy_("");
    }catch(err){
      console.error(err);
      alert(`è¿”å´ä¼ç¥¨OCRã§ã‚¨ãƒ©ãƒ¼: ${err.message || err}`);
      setBusy_("");
    }finally{
      $("btnRetOcr").disabled = false;
    }
  }


  // ===== ãƒ‡ãƒ¼ã‚¿ =====
  async function refresh_(){
    setBusy_("èª­è¾¼ä¸­â€¦");
    const res = await fetchJsonp_(`${API_URL}?action=list`, {});
    if(!res.ok) throw new Error(res.error || "list failed");
    state.items = res.items || [];
    setBusy_("");
    renderList_();
    buildReturnOptions_();
  }

  async function addItem_(){
    const project = $("project").value.trim();
    const name = $("itemName").value.trim();
    const qty_total = Number($("qty").value);
    const start_date = $("startDate").value;
    if(!project || !name || !qty_total || !start_date){
      alert("å¿…é ˆï¼ˆç¾å ´/å“å/æ•°é‡/å€Ÿå…¥æ—¥ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    $("btnAdd").disabled = true;
    setBusy_("ç™»éŒ²ä¸­â€¦");
    try{
      const res = await fetchJsonp_(`${API_URL}?action=addItem`, {
        project, name, qty_total,
        vendor: $("vendor").value.trim(),
        slip_no: $("slipNo").value.trim(),
        slip_url: slipUploadUrl,
        slip_ocr: slipOcrText,
        asset_no: $("assetNo").value.trim(),
        memo: $("memo").value.trim(),
        start_date,
        due_date: $("dueDate").value
      });
      if(!res.ok) throw new Error(res.error || "addItem failed");
      clearForm_();
      await refresh_();
      showView_("list");
      alert("ç™»éŒ²ã—ã¾ã—ãŸ");
    }catch(err){
      console.error(err);
      alert(`ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼: ${err.message || err}`);
    }finally{
      $("btnAdd").disabled = false;
      setBusy_("");
    }
  }

  async function returnItem_(){
    const id = $("retSelect").value;
    const it = state.items.find(x=>x.id === id);
    if(!it){ alert("å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const qty = Number($("retQty").value);
    const return_date = $("retDate").value;
    if(!Number.isFinite(qty) || qty <= 0){ alert("è¿”å´æ•°é‡ãŒä¸æ­£ã§ã™"); return; }
    if(qty > Number(it.qty_out||0)){ alert(`è¿”å´æ•°é‡ãŒæ®‹æ•°(${it.qty_out})ã‚’è¶…ãˆã¦ã„ã¾ã™`); return; }
    if(!return_date){ alert("è¿”å´æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    $("btnReturn").disabled = true;
    setBusy_("è¿”å´ç™»éŒ²ä¸­â€¦");
    try{
      const res = await fetchJsonp_(`${API_URL}?action=returnItem`, {
        id, qty, return_date,
        memo: $("retMemo").value.trim(),
        slip_url: retSlipUploadUrl,
        slip_ocr: retSlipOcrText
      });
      if(!res.ok) throw new Error(res.error || "returnItem failed");
      $("retMemo").value = "";
      await refresh_();
      // é¸æŠç¶­æŒ
      $("retSelect").value = id;
      onReturnSelectChange_();
      
      // è¿”å´ä¼ç¥¨OCRçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      retSlipUploadUrl = "";
      retSlipOcrText = "";
      $("retSlipFile").value = "";
      $("retSlipPreview").classList.add("hidden");
      $("retSlipPreview").src = "";
      $("retSlipInfo").textContent = "";
      $("retOcrTextBox").classList.add("hidden");
      $("retOcrTextBox").textContent = "";
      $("btnRetOcr").disabled = true;

      alert("è¿”å´ç™»éŒ²ã—ã¾ã—ãŸ");

    }catch(err){
      console.error(err);
      alert(`è¿”å´ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼: ${err.message || err}`);
    }finally{
      $("btnReturn").disabled = false;
      setBusy_("");
    }
  }

  async function undoReturn_(){
    const id = $("retSelect").value;
    if(!id){ alert("å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("btnUndo").disabled = true;
    setBusy_("å–æ¶ˆä¸­â€¦");
    try{
      const res = await fetchJsonp_(`${API_URL}?action=undoReturn`, { id });
      if(!res.ok) throw new Error(res.error || "undoReturn failed");
      await refresh_();
      $("retSelect").value = id;
      onReturnSelectChange_();
      alert("ç›´å‰ã®è¿”å´ã‚’å–æ¶ˆã—ã¾ã—ãŸ");
    }catch(err){
      console.error(err);
      alert(`å–æ¶ˆã§ã‚¨ãƒ©ãƒ¼: ${err.message || err}`);
    }finally{
      $("btnUndo").disabled = false;
      setBusy_("");
    }
  }

  // ===== æç”» =====
  function renderList_(){
    const body = $("listBody");
    body.innerHTML = "";
    const q = $("listSearch").value.trim().toLowerCase();
    const items = state.items.slice().sort((a,b)=> String(b.startDate||"").localeCompare(String(a.startDate||"")));
    for(const it of items){
      const hay = `${it.project||""} ${it.name||""} ${it.slipNo||""}`.toLowerCase();
      if(q && !hay.includes(q)) continue;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml_(it.project||"")}</td>
        <td>${escapeHtml_(it.name||"")}</td>
        <td class="right">${Number(it.qty_total||0)}</td>
        <td class="right">${Number(it.qty_out||0)}</td>
        <td>${it.slipUrl ? `<a href="${escapeHtml_(it.slipUrl)}" target="_blank" rel="noopener">ğŸ“</a>` : ""}${it.slipNo ? ` ${escapeHtml_(it.slipNo)}`:""}</td>
        <td>${escapeHtml_(it.startDate||"")}</td>
        <td>${escapeHtml_(it.dueDate||"")}</td>
        <td></td>
      `;
      const td = tr.querySelector("td:last-child");
      const btn = document.createElement("button");
      btn.className = "btn ghost";
      btn.type = "button";
      btn.textContent = "è¿”å´ç™»éŒ²ã¸";
      btn.onclick = ()=>{
        showView_("return");
        $("retSelect").value = it.id;
        onReturnSelectChange_();
      };
      td.appendChild(btn);

      body.appendChild(tr);
    }
  }

  function buildReturnOptions_(){
    const sel = $("retSelect");
    if(!sel) return;
    const q = $("retSearch").value.trim().toLowerCase();
    const keep = sel.value;
    sel.innerHTML = "";
    const items = state.items.slice().sort((a,b)=> (Number(b.qty_out||0) - Number(a.qty_out||0)));
    for(const it of items){
      const hay = `${it.project||""} ${it.name||""} ${it.slipNo||""}`.toLowerCase();
      if(q && !hay.includes(q)) continue;
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.project||""}ï½œ${it.name||""}ï½œæ®‹${it.qty_out||0}` + (it.slipNo?`ï½œä¼ç¥¨:${it.slipNo}`:"");
      sel.appendChild(opt);
    }
    if(keep) sel.value = keep;
    onReturnSelectChange_();
  }

  function onReturnSelectChange_(){
    const id = $("retSelect").value;
    const it = state.items.find(x=>x.id === id);
    $("retQtyOut").textContent = it ? String(it.qty_out||0) : "-";
    if(it){
      $("retQty").max = String(it.qty_out||0);
      const cur = Number($("retQty").value || 1);
      $("retQty").value = String(Math.min(Math.max(1, cur), Math.max(1, Number(it.qty_out||1))));
      $("retSlipLink").innerHTML = it.slipUrl ? `ä¼ç¥¨ç”»åƒ: <a href="${escapeHtml_(it.slipUrl)}" target="_blank" rel="noopener">Driveã§é–‹ã</a>` : "";
      renderReturnHistory_(it);
    }else{
      $("retSlipLink").textContent = "";
      renderReturnHistory_(null);
    }
  }

  function renderReturnHistory_(it){
    const empty = $("retHistoryEmpty");
    const table = $("retHistoryTable");
    const body = $("retHistoryBody");
    body.innerHTML = "";
    if(!it){
      empty.textContent = "å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      empty.classList.remove("hidden");
      table.classList.add("hidden");
      return;
    }
    const rows = (it.returns || []).slice().reverse();
    if(rows.length === 0){
      empty.textContent = "è¿”å´å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      empty.classList.remove("hidden");
      table.classList.add("hidden");
      return;
    }
    empty.classList.add("hidden");
    table.classList.remove("hidden");
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml_(r.date||"")}</td><td class="right">${r.qty ?? ""}</td><td>${(r.slipUrl?`<a href="${escapeHtml_(r.slipUrl)}" target="_blank" rel="noopener">ğŸ“</a> `:"")}${escapeHtml_(r.memo||"")}</td>`;
      body.appendChild(tr);
    }
  }

  function clearForm_(){
    $("project").value = "";
    $("itemName").value = "";
    $("qty").value = "";
    $("vendor").value = "";
    $("slipNo").value = "";
    $("assetNo").value = "";
    $("memo").value = "";
    $("dueDate").value = "";
    // OCR state reset
    slipUploadUrl = "";
    slipOcrText = "";
    $("slipFile").value = "";
    $("slipPreview").classList.add("hidden");
    $("slipPreview").src = "";
    $("slipInfo").textContent = "";
    $("ocrTextBox").classList.add("hidden");
    $("ocrTextBox").textContent = "";
    $("btnOcr").disabled = true;
  }

  // ===== åˆæœŸåŒ– =====
  async function init(){
    // default dates
    $("startDate").value = toYmdToday_();
    $("retDate").value = toYmdToday_();

    // tabs
    $("tabNew").addEventListener("click", ()=> showView_("new"));
    $("tabList").addEventListener("click", ()=> showView_("list"));
    $("tabReturn").addEventListener("click", ()=> showView_("return"));

    // actions
    $("btnAdd").addEventListener("click", addItem_);
    $("btnClear").addEventListener("click", clearForm_);
    $("btnRefresh").addEventListener("click", refresh_);
    $("listSearch").addEventListener("input", renderList_);

    // return screen
    $("retSearch").addEventListener("input", buildReturnOptions_);
    $("retSelect").addEventListener("change", onReturnSelectChange_);
    $("btnReturn").addEventListener("click", returnItem_);
    $("btnUndo").addEventListener("click", undoReturn_);

    // OCR bindings
    $("btnCamera").addEventListener("click", ()=> $("slipFile").click());
    $("slipFile").addEventListener("change", async ()=>{
      const f = $("slipFile").files && $("slipFile").files[0];
      if(!f){
        $("btnOcr").disabled = true;
        return;
      }
      $("btnOcr").disabled = false;
      const dataUrl = await fileToDataUrl_(f);
      $("slipPreview").src = dataUrl;
      $("slipPreview").classList.remove("hidden");
      $("slipInfo").textContent = `${f.name}ï¼ˆ${Math.round(f.size/1024)}KBï¼‰`;
    });
    $("btnOcr").addEventListener("click", runOcrUpload_);


    // return slip OCR
    $("btnRetCamera").addEventListener("click", ()=> $("retSlipFile").click());
    $("retSlipFile").addEventListener("change", async ()=>{
      const f = $("retSlipFile").files && $("retSlipFile").files[0];
      if(!f){
        $("btnRetOcr").disabled = true;
        return;
      }
      $("btnRetOcr").disabled = false;
      const dataUrl = await fileToDataUrl_(f);
      $("retSlipPreview").src = dataUrl;
      $("retSlipPreview").classList.remove("hidden");
      $("retSlipInfo").textContent = `${f.name}ï¼ˆ${Math.round(f.size/1024)}KBï¼‰`;
    });
    $("btnRetOcr").addEventListener("click", runRetOcrUpload_);

    // first load

    try{
      await refresh_();
      showView_("new");
    }catch(err){
      console.error(err);
      alert("åˆå›èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚API_URLï¼ˆGASã®URLï¼‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n" + (err.message||err));
      setBusy_("");
    }
  }
  init();
</script>
</body>
</html>
